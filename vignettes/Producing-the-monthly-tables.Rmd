---
title: "Producing the monthly tables"
author: "Simon Thelwall"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Producing the monthly tables}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, echo=FALSE}
library(hcaidcs)
```

## Introduction
The production of the monthly tables has been automated as far as possible. 
This vignette describes the procedure for their production. 
Monthly tables cover 13-month rolling counts for each collection, by acute trust and CCG. 
MRSA tables also include by PIR assignment. 

The process is as automated as I have been able to make it. 
However, some manual adjustments will need to be made, specifically the meta data about changes since previous publication and italicisation of months in which data are likely to change. 

## Dependencies
The following packages need to be installed for this to work:

 * dplyr
 * xlsx
 * tidyr
 * lubridate
 * RODBC
 * stringr
 * hcaidcs

ODBC connections to: 

 * Mandatory Data
 * Org Curr Dev
 * new org structure_NEW

## Overview
Monthly tables are published on the first Wednesday of every month. 
The data for month *m* are extracted in *m* + 1 and published in *m* + 2.
i.e. for June data, the extract is taken and tables prepared in July, then published in August. 

The master directory for the monthly tables is `K:\Monthly Output`.
Within that, the folder `monthly_r_scripts` contains the R scripts to be run to produce the tables. 
Within the master directory, each month has a folder in the format `Monthname_YYYY`.
Extracted data are stored in a subfolder `Downloads` within the month folder.

The following summarises the procedure for preparing the monthly tables: 

1. Extract data to the `Downloads` subfolder of the current month's folder
1. Update the caveats in the template xlsx files
1. Update the known issues with PIR assignment in file `monthly_mrsa.R`
1. Run the code in `prep_monthly_tables.R` down to line 103
1. Run each of the collection R scripts (e.g. `monthly_mrsa.R`, etc.)
1. In addition to the monthly tables, there are 12 month annual tables that get updated each year. This is handled by the `update_annual...mrsa.R` file
1. In the resultant outputs do the following: 
    * add the grey cell highlights for trusts where data have not been signed off
    * italicise the last three months of data as these may change in future publications
    * highlight cells where the values are different to previous months
1. Paste the contents of the `trust_caveats.txt` and `CCG_caveats.txt` to the appropriate positions in the caveats worksheets
1. After completion, the Excel files will need to be saved as .ods files. 

## Handling specialist commissioning hubs
Specialist commissioning hubs are detected using the `is_sch()` function, based on the CCG name. 
Hubs are all recoded to `zSCH` and `zSpecialist Commissioning Hubs`.
The `z` is to ensure that hubs are sorted to the bottom of the table. 

## Special functions

### data_compare
Used to compare data from one month to another to identify cells which have changed from one publication to another. 
This can then be used in the export to format the background fill of cells.

### the_months
The function `the_months()` returns a vector of 13 months from a supplied date. 
```{r, message=FALSE}
library(lubridate)
mo_curr_months <- function(x){
  x <- x - years(1)
  mo_df <- data.frame(mo_seq = seq(1, 13, 1), 
                      mo_now = lubridate::rollback(x, roll_to_first = TRUE))
  mo_df$first_day_text <- mo_df$mo_now %m+% months(mo_df$mo_seq - 1)
  mo_df$the_month <- paste(as.character(month(mo_df$first_day_text, label = TRUE, abbr = FALSE)), 
                           year(mo_df$first_day_text))
  mo_df$the_month <- factor(mo_df$the_month, levels = as.ordered(mo_df$the_month))
  the_months <- mo_df$the_month
  return(the_months)
}

the_months <- mo_curr_months(today())
```

This can be used to get the thirteen months from today's date (using `today()`) or from any arbitrary date. 
```{r}
mo_curr_months(dmy("01/02/2015"))
```
This is then used to get a data frame of organisations and months for reporting. 

### mo_pub_date
Nicely prints the string for the publication date. 
This is used to update the date of publication for the tables. 
This is printed in the top-left corner of each table. 
```{r}
mo_pub_date()
```
